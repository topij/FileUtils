# Enhanced DOCX Template System

FileUtils now includes a comprehensive DOCX template system that provides:

- **Template Support**: Use existing DOCX templates with custom styles
- **Markdown Conversion**: Convert markdown content to professionally formatted DOCX
- **Style Mapping**: Customize how elements are styled in the output
- **Reviewer Workflow**: Built-in support for document review processes
- **Provenance Tracking**: Automatic metadata and source tracking

## Quick Start

```python
from FileUtils import FileUtils, OutputFileType

# Initialize with template configuration
file_utils = FileUtils(
    config_override={
        "docx_templates": {
            "template_dir": "templates",
            "templates": {
                "default": "IP-template-doc.docx",
                "review": "review-template.docx"
            }
        },
        "style_mapping": {
            "table": "IP-table_light",
            "heading_1": "Heading 1"
        }
    }
)

# Convert markdown to DOCX with template
file_utils.save_document_to_storage(
    content=markdown_content,
    output_filetype=OutputFileType.DOCX,
    template="review",
    add_provenance=True,
    add_reviewer_instructions=True
)
```

## Features

### 1. Template Management

The template system supports multiple templates and automatic fallback:

```python
# List available templates
from FileUtils.templates import DocxTemplateManager

template_manager = DocxTemplateManager(file_utils.config)
templates = template_manager.list_available_templates()
print(f"Available templates: {list(templates.keys())}")

# Get template information
info = template_manager.get_template_info("default")
print(f"Template info: {info}")
```

### 2. Markdown to DOCX Conversion

Convert markdown content to professionally formatted DOCX:

```python
markdown_content = """# Project Report

## Key Findings

- **Important**: We've achieved 95% completion
- [ ] Complete final testing
- [x] Update documentation

| Metric | Value | Status |
|--------|-------|--------|
| Progress | 95% | ✅ On Track |
| Budget | $45,000 | ✅ Under Budget |

## Next Steps

1. Complete testing phase
2. Prepare documentation
3. Schedule review
"""

# Convert with template and options
saved_path, _ = file_utils.save_document_to_storage(
    content=markdown_content,
    output_filetype=OutputFileType.DOCX,
    template="review",
    add_provenance=True,
    add_reviewer_instructions=True,
    source_file="project_report.md"
)
```

### 3. Style Mapping

Customize how elements are styled in the output:

```python
style_mapping = {
    "table": "IP-table_light",        # Custom table style
    "table_fallback": "IP-table",      # Fallback table style
    "heading_1": "Heading 1",         # Heading styles
    "list_bullet": "List Bullet",     # List styles
    "list_number": "List Number"
}

file_utils = FileUtils(
    config_override={"style_mapping": style_mapping}
)
```

### 4. Reviewer Workflow Support

Built-in support for document review processes:

```python
# Enable reviewer instructions
file_utils.save_document_to_storage(
    content=content,
    output_filetype=OutputFileType.DOCX,
    template="review",
    add_reviewer_instructions=True,  # Adds reviewer instructions section
    add_provenance=True              # Adds provenance header
)
```

The reviewer instructions include:
- TODO item resolution guidelines
- Resolution field requirements
- Review process steps
- Document modification instructions

### 5. Provenance Tracking

Automatic metadata and source tracking:

```python
# Automatic provenance header
file_utils.save_document_to_storage(
    content=content,
    output_filetype=OutputFileType.DOCX,
    source_file="source.md",  # Source file for provenance
    add_provenance=True       # Adds "Autogenerated from source.md on 2024-01-15"
)
```

## Configuration

### Template Configuration

Configure templates in your FileUtils configuration:

```yaml
# config.yaml
docx_templates:
  template_dir: "templates"
  default_template: "IP-template-doc.docx"
  templates:
    default: "IP-template-doc.docx"
    review: "review-template.docx"
    report: "report-template.docx"
    simple: null  # Use default document

style_mapping:
  table: "IP-table_light"
  table_fallback: "IP-table"
  table_default: "Table Grid"
  heading_1: "Heading 1"
  heading_2: "Heading 2"
  list_bullet: "List Bullet"
  list_number: "List Number"

markdown_options:
  add_provenance: true
  add_reviewer_instructions: false
  preserve_formatting: true
  checkbox_symbols:
    unchecked: "☐"
    checked: "☑"
    font: "Segoe UI Symbol"
    size: 12
```

### Programmatic Configuration

```python
config = {
    "docx_templates": {
        "template_dir": "custom_templates",
        "templates": {
            "corporate": "corporate-template.docx",
            "technical": "technical-template.docx"
        }
    },
    "style_mapping": {
        "table": "Corporate-Table",
        "heading_1": "Corporate-Heading-1"
    }
}

file_utils = FileUtils(config_override=config)
```

## Supported Markdown Features

The markdown converter supports:

### Headings
```markdown
# Heading 1
## Heading 2
### Heading 3
```

### Lists
```markdown
- Bullet point 1
- Bullet point 2
  - Nested bullet

1. Numbered item 1
2. Numbered item 2
```

### Checkboxes
```markdown
- [ ] Unchecked item
- [x] Checked item
```

### Tables
```markdown
| Column 1 | Column 2 | Column 3 |
|----------|----------|----------|
| Data 1   | Data 2   | Data 3   |
| Data 4   | Data 5   | Data 6   |
```

### Formatting
```markdown
**Bold text**
*Italic text*
`Code text`
[Link text](https://example.com)
```

### Line Breaks
```markdown
Line 1<br>Line 2
```

## Template Requirements

### Template Structure

Your DOCX templates should:

1. **Be Regular DOCX Files**: Use standard `.docx` files (not `.dotx` template files)
2. **Contain Styles**: Include the styles you want to use (e.g., "IP-table_light", "Heading 1")
3. **Be Clean**: Template content will be cleared, but styles are preserved
4. **Be Accessible**: Place templates in the configured template directory

**Important**: FileUtils uses regular `.docx` files as templates, not Microsoft Word `.dotx` template files. The system loads the DOCX file, clears its content, and preserves the styles for use in the generated documents.

### Style Names

The system looks for these style names (configurable):

- **Tables**: "IP-table_light", "IP-table", "Table Grid"
- **Headings**: "Heading 1", "Heading 2", etc.
- **Lists**: "List Bullet", "List Number", "List Paragraph"
- **Text**: "Normal", "Title", "Subtitle"

### Template Locations

Templates are searched in this order:

1. `{template_dir}/{template_filename}`
2. `templates/{template_filename}`
3. `data/templates/{template_filename}`
4. `{template_filename}` (current directory)
5. `src/conversion/templates/{template_filename}` (legacy location)

## Advanced Usage

### Custom Style Mapper

```python
from FileUtils.templates import StyleMapper

# Create custom style mapper
style_mapper = StyleMapper({
    "table": "My-Custom-Table",
    "heading_1": "My-Heading-1"
})

# Use with converter
from FileUtils.templates import MarkdownToDocxConverter

converter = MarkdownToDocxConverter(template_manager, style_mapper)
doc = converter.convert_markdown_to_docx(markdown_content)
```

### Direct Template Usage

```python
# Use specific template without markdown conversion
file_utils.save_document_to_storage(
    content={
        "title": "Document Title",
        "sections": [
            {
                "heading": "Section 1",
                "level": 1,
                "text": "Section content"
            }
        ]
    },
    output_filetype=OutputFileType.DOCX,
    template="corporate"
)
```

### Template Validation

```python
from FileUtils.templates import DocxTemplateManager

template_manager = DocxTemplateManager(config)

# Validate template
is_valid = template_manager.validate_template(template_path)

# Get template information
info = template_manager.get_template_info("default")
print(f"Available styles: {info['available_styles']}")
```

## Error Handling

The system includes comprehensive error handling:

- **Template Not Found**: Falls back to default document
- **Style Not Available**: Uses fallback styles or defaults
- **Import Errors**: Graceful degradation if template system unavailable
- **Invalid Content**: Clear error messages for debugging

## Migration from Old Script

If you're migrating from the old `markdown_to_docx.py` script:

### Old Script Features → FileUtils Features

| Old Script | FileUtils |
|------------|-----------|
| `MarkdownToDocxConverter` | `MarkdownToDocxConverter` (enhanced) |
| `template_file` parameter | `template` parameter |
| Hardcoded styles | Configurable `style_mapping` |
| Manual template clearing | Automatic template management |
| Basic error handling | Comprehensive error handling |
| Single file conversion | Integrated with FileUtils workflow |

### Migration Steps

1. **Move Templates**: Place your templates in `data/templates/`
2. **Update Configuration**: Add template config to FileUtils
3. **Update Code**: Replace direct converter usage with FileUtils methods
4. **Test**: Verify output matches your expectations

### Example Migration

**Old Script:**
```python
converter = MarkdownToDocxConverter("IP-template-doc.docx")
converter.convert_file("input.md", "output.docx")
```

**FileUtils:**
```python
file_utils = FileUtils(config_override={
    "docx_templates": {
        "templates": {"default": "IP-template-doc.docx"}
    }
})

file_utils.save_document_to_storage(
    content=markdown_content,
    output_filetype=OutputFileType.DOCX,
    template="default"
)
```

## Best Practices

### Template Design

1. **Use Clear Style Names**: Make style names descriptive and consistent
2. **Test Fallbacks**: Ensure fallback styles work if custom styles unavailable
3. **Keep Templates Clean**: Remove unnecessary content, keep only styles
4. **Document Styles**: Document which styles your templates provide

### Configuration Management

1. **Environment-Specific**: Use different templates for different environments
2. **Version Control**: Keep templates in version control
3. **Validation**: Validate templates before deployment
4. **Documentation**: Document template requirements and usage

### Content Preparation

1. **Clean Markdown**: Use consistent markdown formatting
2. **Test Conversion**: Test with various content types
3. **Review Output**: Always review generated documents
4. **Iterate**: Refine templates based on output quality

## Troubleshooting

### Common Issues

#### Template Not Found
```
Template 'custom' not found in configuration
```
**Solution**: Check template configuration and file paths

#### Style Not Available
```
Style 'IP-table_light' not found, using fallback
```
**Solution**: Check template has the required styles or update style mapping

#### Import Errors
```
Template system not available, using simple conversion
```
**Solution**: Ensure `python-docx` is installed: `pip install 'FileUtils[documents]'`

### Debug Mode

Enable debug logging to see template system activity:

```python
file_utils = FileUtils(log_level="DEBUG")
```

### Template Validation

Validate your templates:

```python
from FileUtils.templates import DocxTemplateManager

template_manager = DocxTemplateManager(config)
info = template_manager.get_template_info("default")
print(f"Template validation: {info}")
```

## Examples

See `examples/enhanced_docx.py` for comprehensive examples including:

- Markdown conversion with templates
- Structured content creation
- Template management
- Configuration options
- Error handling

## Future Enhancements

Planned enhancements include:

- **Additional Templates**: More built-in templates
- **Style Customization**: More granular style control
- **Batch Processing**: Convert multiple markdown files
- **Template Editor**: GUI for template management
- **Advanced Formatting**: More markdown features
- **Export Options**: Additional output formats
